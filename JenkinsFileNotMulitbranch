#!/usr/bin/env groovy
@Library('jeap-pipelinelibrary@master') _
pipeline {

    agent {
        node {
            label 'docker'
        }
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipStagesAfterUnstable()
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }

    stages {
        stage('Prepare build environment') {
            steps {
                script {
                    mavenPrepare { }
                }
            }
        }

        stage('Build and Deploy EETS-P-I-S for Test-Container') {
            steps {
                script {

//                    def buildNumber = utils.getDevVersion(config.versionNumberType)
//                    env.ARTIFACT_VERSION = utils.getMavenReleaseVersion(buildNumber)+"-TestContainer"

                    docker.withRegistry('https://repo.bit.admin.ch:8444', 'nexusCredentials') {
                        def jdk = docker.image('bit/openjdk:8-jdk')
                        jdk.pull()
                        jdk.inside('-u root') {
//                             sh "sh mvnw dependency:get -DgroupId=ch.admin.ezv.eets -DartifactId=eets-provider-interface-service -Dversion=0.17.0-8  -Ddest=eets-provider-interface-service/eets-provider-interface-service.jar"
//                             sh "sh mvnw dependency:get -DgroupId=ch.admin.ezv.eets -DartifactId=eets-test-support-service -Ddest=eets-test-support-service/eets-test-support-service.jar"

                        }
                    }
                }
            }
        }

        stage('Push to Github') {
            steps {
                script {
                    git changelog: false, credentialsId: '4a68abf6-d9bf-424a-8222-004426031766', poll: false, url: 'https://github.com/olle71/ezv_eets.git'
//                    withCredentials([usernamePassword(credentialsId: '4a68abf6-d9bf-424a-8222-004426031766', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
//                        sh "git fetch"
//                    }
                    sh "git status"

//                    //sh "git fetch"
//                    withCredentials([usernamePassword(credentialsId: '4a68abf6-d9bf-424a-8222-004426031766', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
//                        sh "git status"
//                        sh "git checkout -f master"
//                        sh "git add *"
//                        sh "git commit -m 'hello github'"
//                        sh('git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/olle71/ezv_eets.git')
//                    }


//                    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: '4a68abf6-d9bf-424a-8222-004426031766', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD']]) {
//                        echo "hello : ${GIT_USERNAME}"
////                        sh "wget https://github.com/"
//                        sh "git checkout master"
//                        sh "git status"
//                        sh "git config --get remote.origin.url"
//                        sh "git add *"
//                        sh "git commit -m 'hello github'"
//                        sh "git push -u https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/olle71/ezv_eets.git master"
//                    }

                }
            }
        }
    }
}
